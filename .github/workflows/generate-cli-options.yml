name: Generate CLI Options

on:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      tools:
        description: 'Comma-separated list of tools to generate (or "all")'
        required: false
        default: 'all'
        type: string
      create-pr:
        description: 'Create a pull request with changes'
        required: false
        default: true
        type: boolean

jobs:
  # Generate options for each tool in parallel (Linux)
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        tool:
          - helm
          - kubectl
          - docker
          - az
          - dotnet
          - gcloud
          - terraform
          - yarn
          - aws

    steps:
      - name: Check if tool should run
        id: should-run
        run: |
          TOOLS="${{ github.event.inputs.tools || 'all' }}"
          if [[ "$TOOLS" == "all" ]] || [[ "$TOOLS" == *"${{ matrix.tool }}"* ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        if: steps.should-run.outputs.run == 'true'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Cache NuGet
        if: steps.should-run.outputs.run == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # Install CLI tools needed for CLI-first scraping
      - name: Install Helm
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'helm'
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Install kubectl
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'kubectl'
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install Azure CLI
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'az'
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Install Google Cloud CLI
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'gcloud'
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update && sudo apt-get install -y google-cloud-cli

      - name: Install Terraform
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'terraform'
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install -y terraform

      - name: Install Yarn
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'yarn'
        run: |
          corepack enable
          corepack prepare yarn@stable --activate

      - name: Install AWS CLI
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'aws'
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install

      # Docker is pre-installed on ubuntu-latest
      # .NET CLI is installed via setup-dotnet

      - name: Build Generator
        if: steps.should-run.outputs.run == 'true'
        run: dotnet build -c Release
        working-directory: tools/ModularPipelines.OptionsGenerator/src/ModularPipelines.OptionsGenerator

      - name: Run Generator for ${{ matrix.tool }}
        if: steps.should-run.outputs.run == 'true'
        run: |
          dotnet run -c Release -- \
            --tools "${{ matrix.tool }}" \
            --output-dir "${{ github.workspace }}"
        working-directory: tools/ModularPipelines.OptionsGenerator/src/ModularPipelines.OptionsGenerator

      - name: Check for changes
        if: steps.should-run.outputs.run == 'true'
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git diff --staged --name-only
          fi

      - name: Build solution to verify changes
        if: steps.should-run.outputs.run == 'true' && steps.changes.outputs.has_changes == 'true'
        run: dotnet build ModularPipelines.sln -c Release

      - name: Create Pull Request for ${{ matrix.tool }}
        if: steps.should-run.outputs.run == 'true' && steps.changes.outputs.has_changes == 'true' && (github.event.inputs.create-pr != 'false')
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Update ${{ matrix.tool }} CLI options"
          title: "[Automated] Update ${{ matrix.tool }} CLI Options"
          body: |
            ## Summary
            This PR contains automatically generated updates to **${{ matrix.tool }}** CLI options classes.

            The generator scraped the latest CLI help output from the installed tool.

            ## Changes
            - Updated options classes to reflect latest CLI documentation
            - Added new commands if any were detected
            - Updated option types and descriptions

            ## Verification
            - [x] Solution builds successfully

            ---
            ðŸ¤– Generated with ModularPipelines.OptionsGenerator
          branch: automated/update-cli-options-${{ matrix.tool }}
          base: main
          delete-branch: true
          labels: |
            automated
            dependencies

  # Generate options for Windows-only tools
  generate-windows:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        tool:
          - choco
          - winget

    steps:
      - name: Check if tool should run
        id: should-run
        shell: pwsh
        run: |
          $tools = "${{ github.event.inputs.tools }}"
          if ([string]::IsNullOrEmpty($tools)) { $tools = "all" }
          if ($tools -eq "all" -or $tools -match "${{ matrix.tool }}") {
            "run=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "run=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Checkout
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        if: steps.should-run.outputs.run == 'true'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Cache NuGet
        if: steps.should-run.outputs.run == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Install Chocolatey
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'choco'
        shell: pwsh
        run: |
          # Chocolatey is pre-installed on windows-latest
          choco --version

      - name: Install WinGet
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'winget'
        shell: pwsh
        run: |
          # WinGet is pre-installed on windows-latest (Windows Server 2022)
          winget --version

      - name: Build Generator
        if: steps.should-run.outputs.run == 'true'
        run: dotnet build -c Release
        working-directory: tools/ModularPipelines.OptionsGenerator/src/ModularPipelines.OptionsGenerator

      - name: Run Generator for ${{ matrix.tool }}
        if: steps.should-run.outputs.run == 'true'
        shell: pwsh
        run: |
          dotnet run -c Release -- `
            --tools "${{ matrix.tool }}" `
            --output-dir "${{ github.workspace }}"
        working-directory: tools/ModularPipelines.OptionsGenerator/src/ModularPipelines.OptionsGenerator

      - name: Check for changes
        if: steps.should-run.outputs.run == 'true'
        id: changes
        shell: pwsh
        run: |
          git add -A
          $diff = git diff --staged --quiet; $hasChanges = $LASTEXITCODE -ne 0
          if ($hasChanges) {
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Changed files:"
            git diff --staged --name-only
          } else {
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Build solution to verify changes
        if: steps.should-run.outputs.run == 'true' && steps.changes.outputs.has_changes == 'true'
        run: dotnet build ModularPipelines.sln -c Release

      - name: Create Pull Request for ${{ matrix.tool }}
        if: steps.should-run.outputs.run == 'true' && steps.changes.outputs.has_changes == 'true' && (github.event.inputs.create-pr != 'false')
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Update ${{ matrix.tool }} CLI options"
          title: "[Automated] Update ${{ matrix.tool }} CLI Options"
          body: |
            ## Summary
            This PR contains automatically generated updates to **${{ matrix.tool }}** CLI options classes.

            The generator scraped the latest CLI help output from the installed tool.

            ## Changes
            - Updated options classes to reflect latest CLI documentation
            - Added new commands if any were detected
            - Updated option types and descriptions

            ## Verification
            - [x] Solution builds successfully

            ---
            ðŸ¤– Generated with ModularPipelines.OptionsGenerator
          branch: automated/update-cli-options-${{ matrix.tool }}
          base: main
          delete-branch: true
          labels: |
            automated
            dependencies
