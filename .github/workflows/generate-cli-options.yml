name: Generate CLI Options

on:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      tools:
        description: 'Comma-separated list of tools to generate (or "all")'
        required: false
        default: 'all'
        type: string
      create-pr:
        description: 'Create a pull request with changes'
        required: false
        default: true
        type: boolean

jobs:
  # Generate options for each tool in parallel
  generate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool:
          - helm
          - kubectl
          - docker
          - az
          - dotnet
          - gcloud

    steps:
      - name: Check if tool should run
        id: should-run
        run: |
          TOOLS="${{ github.event.inputs.tools || 'all' }}"
          if [[ "$TOOLS" == "all" ]] || [[ "$TOOLS" == *"${{ matrix.tool }}"* ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup .NET
        if: steps.should-run.outputs.run == 'true'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Cache NuGet
        if: steps.should-run.outputs.run == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # Install CLI tools needed for CLI-first scraping
      - name: Install Helm
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'helm'
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Install kubectl
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'kubectl'
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install Azure CLI
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'az'
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Install Google Cloud CLI
        if: steps.should-run.outputs.run == 'true' && matrix.tool == 'gcloud'
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update && sudo apt-get install -y google-cloud-cli

      # Docker is pre-installed on ubuntu-latest
      # .NET CLI is installed via setup-dotnet

      - name: Build Generator
        if: steps.should-run.outputs.run == 'true'
        run: dotnet build -c Release
        working-directory: tools/ModularPipelines.OptionsGenerator/src/ModularPipelines.OptionsGenerator

      - name: Run Generator for ${{ matrix.tool }}
        if: steps.should-run.outputs.run == 'true'
        run: |
          dotnet run -c Release -- \
            --tools "${{ matrix.tool }}" \
            --output-dir "${{ github.workspace }}"
        working-directory: tools/ModularPipelines.OptionsGenerator/src/ModularPipelines.OptionsGenerator

      - name: Upload generated files
        if: steps.should-run.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-${{ matrix.tool }}
          path: |
            src/ModularPipelines.*/Options/**
            src/ModularPipelines.*/Enums/**
            src/ModularPipelines.*/Services/**
            src/ModularPipelines.*/Extensions/**
          if-no-files-found: ignore
          retention-days: 1

  # Combine all generated files and create PR
  create-pr:
    needs: generate
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: generated-*
          merge-multiple: true

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git diff --staged --name-only
          fi

      - name: Setup .NET
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Build solution to verify changes
        if: steps.changes.outputs.has_changes == 'true'
        run: dotnet build ModularPipelines.sln -c Release

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && (github.event.inputs.create-pr != 'false')
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Update generated CLI options"
          title: "[Automated] Update CLI Options from Documentation"
          body: |
            ## Summary
            This PR contains automatically generated updates to CLI options classes.

            The generator scraped the latest documentation from:
            - Helm (helm.sh)
            - kubectl (kubernetes.io)
            - Docker (docs.docker.com)
            - Azure CLI (learn.microsoft.com)
            - .NET CLI (learn.microsoft.com)
            - Google Cloud CLI (cloud.google.com)

            ## Changes
            - Updated options classes to reflect latest CLI documentation
            - Added new commands if any were detected
            - Updated option types and descriptions

            ## Verification
            - [x] Solution builds successfully

            ---
            ðŸ¤– Generated with ModularPipelines.OptionsGenerator
          branch: automated/update-cli-options
          base: main
          delete-branch: true
          labels: |
            automated
            dependencies
